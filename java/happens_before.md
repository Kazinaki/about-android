- [Назад](/./java.md)

## Happens-before

**happens-before** отношение операций:

Пусть есть поток **X** и поток **Y** (не обязательно отличающийся от потока **X**). И пусть есть операции **A** (выполняющиеся в потоке **X**) и **B**(выполняющиеся в потоке **Y**).

В таком случае отношение **A happens-before B** означает, что все изменения, выполненные потока **X** до момента операции **A** и изменения, которые повлекла эта операци, видны потоку **Y** в момент выполнения операции **B** и после выполнения этой операции.

![Happens-before](/img/happens_before01.png)

## Операции, связанные отношением happens-before

- Захват монитора (начало synchronized, метод lock) и всё, что после него в том же потоке.
- Возврат монитора (конец synchronized, метод unlock) и всё, что перед ним в том же потоке.
- Возврат монитора и последующий захват другим потоком.
- Любые зависимости по данным (то есть запись в любую переменную и последующее чтение её же) в одном потоке.
- Всё, что в том же потоке перед записью в volatile-переменную, и сама запись.
- volatile-чтение и всё, что после него в том же потоке.
- Запись в volatile-переменную и последующее считывание её же. Таким образом, volatile-запись делает с памятью то же, что возврат монитора, а чтение — то же, что захват. А значит: если один поток записал в volatile-переменную, а второй обнаружил это, всё, что предшествует записи, выполняется раньше всего, что идёт после чтения.
- Статическая инициализация и любые действия с любыми экземплярами объектов.
- Запись в final-поля в конструкторе и всё, что после конструктора. Как исключение из всеобщей транзитивности, это соотношение happens-before не соединяется транзитивно с другими правилами и поэтому может вызвать межпоточную гонку.
- Любая работа с объектом и finalize().
- Запуск потока и любой код в потоке.
- Зануление переменных, относящихся к потоку, и любой код в потоке.
- Код в потоке и join(); код в потоке и isAlive() == false.
- interrupt() потока и обнаружение факта останова.
